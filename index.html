# index.py

import os
import time
import pandas as pd
from concurrent.futures import ThreadPoolExecutor
from tkinter import Tk, filedialog, messagebox

def selecionar_pdfs():
    """Abre uma janela para o usuário selecionar arquivos PDF."""
    root = Tk()
    root.withdraw()
    return filedialog.askopenfilenames(
        title="Selecione os arquivos PDF",
        filetypes=[("Arquivos PDF", "*.pdf")]
    )

def extract_text_from_pdf(path):
    """Extrai o texto de todas as páginas de um PDF."""
    import fitz  # PyMuPDF
    doc = fitz.open(path)
    text = "".join(page.get_text() for page in doc)
    doc.close()
    return path, text

def main():
    pdf_paths = selecionar_pdfs()
    if not pdf_paths:
        messagebox.showwarning("Aviso", "Nenhum arquivo PDF foi selecionado.")
        return

    inicio = time.time()

    with ThreadPoolExecutor() as executor:
        resultados = list(executor.map(extract_text_from_pdf, pdf_paths))

    from tela import create_tela_client
    tela = create_tela_client(api_key="b688428d-e6e1-46db-b604-22d78aa0604a")

    dados_consolidados = []
    for _, conteudo_pdf in resultados:
        data = tela.completions.create(
            canvas_id="496722d2-bb2f-4f12-962d-4f34ba7d9db8",
            variables={"arquivo": conteudo_pdf},
        )
        resposta = data.choices[0].message.content["Composição do documento de arrecadação"]
        dados_consolidados.extend(resposta)

    df = pd.DataFrame(dados_consolidados)

    if "NumeroDocumento" in df.columns and "NumeroPagina" in df.columns:
        df["NumeroPagina"] = df.groupby("NumeroDocumento").cumcount() + 1

    pasta_script = os.path.dirname(os.path.abspath(__file__))
    excel_path = os.path.join(pasta_script, "Resultado_Extração_PDF.xlsx")

    with pd.ExcelWriter(excel_path, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='Relatório')
        workbook = writer.book
        worksheet = writer.sheets['Relatório']

        header_format = workbook.add_format({
            'bold': True,
            'bg_color': '#1F4E78',
            'font_color': 'white',
            'align': 'center'
        })
        for col_num, value in enumerate(df.columns.values):
            worksheet.write(0, col_num, value, header_format)

        worksheet.autofilter(0, 0, len(df), len(df.columns) - 1)
        for i, col in enumerate(df.columns):
            max_len = max(df[col].astype(str).map(len).max(), len(col)) + 2
            worksheet.set_column(i, i, max(max_len, 15))

    fim = time.time()
    minutos = int((fim - inicio) // 60)
    segundos = int((fim - inicio) % 60)

    messagebox.showinfo(
        "Relatório Finalizado",
        f"O relatório consolidado foi gerado e salvo com sucesso!\nTempo de processamento: {minutos} min {segundos} seg"
    )

    os.startfile(pasta_script)

if __name__ == "__main__":
    main()
